# 大语言模型文字冒险游戏

一个基于Python和阿里云百炼API的智能文字冒险游戏框架，具备图形用户界面和动态故事生成功能。

## 功能特点

- **图形用户界面 (GUI)**：使用Tkinter构建，界面友好，无需在终端中操作
- **优化的窗口布局**：自适应窗口大小，内容区域比例合理，减少滚动需求
- **动态API密钥**：游戏启动后可在界面中输入阿里云百炼API Key
- **自定义故事背景**：可自由设定游戏的初始世界观和情节
- **Markdown支持**：游戏主要内容展示区域支持Markdown格式，包括标题、粗体、列表等
- **智能情节生成**：AI根据当前故事情节生成后续内容和四个选项
- **长期记忆**：程序将整个故事摘要连同玩家选择一起发送给AI，确保故事连贯性
- **异步处理**：与AI模型的通信在后台线程中进行，防止界面卡死

## 环境要求

- Python 3.7+
- Windows/macOS/Linux

## 安装步骤

### 第一步：安装Python依赖

打开终端（或CMD/PowerShell）并运行以下命令：

```bash
pip install -r requirements.txt
```

或者手动安装：

```bash
pip install dashscope
pip install tk_html_widgets
pip install markdown2
```

### 第二步：获取阿里云百炼API Key

1. 访问[阿里云百炼（DashScope）官方网站](https://dashscope.aliyun.com/)
2. 登录您的阿里云账户
3. 进入"管理中心"，找到"API-KEY管理"
4. 创建一个新的API Key并复制它
5. 请妥善保管这个Key

## 使用方法

### 启动游戏

根据您的需求选择不同版本的游戏：

```bash
# 启动最终优化版（推荐）
python llm_adventure_game_final.py

# 启动基础版
python llm_adventure_game.py

# 启动简单版
python llm_adventure_game_simple.py
```

### 游戏操作

1. **设置API Key**：在界面顶部的"API-KEY（找陈狗要）"输入框中粘贴您的API Key
2. **自定义参数**：
   - 输入模型：可选择不同的AI模型（默认：qwen-turbo）
   - 单段字数范围：设置AI生成的故事段落长度（默认：300-500）
   - 故事类型：指定故事风格（如末世、爽文、悬疑等）
   - 选项风格：指定选项的特点（如爽文、擦边、激进等）
3. **自定义故事背景**：在"故事背景设定"文本框中输入您想要的故事背景
4. **开始游戏**：点击"开始 / 重置游戏"按钮
5. **选择行动**：AI会生成四个选项，在输入框中输入选项编号(1-4)并点击"确认选择"
6. **继续冒险**：AI会根据您的选择继续生成故事情节

## 代码结构

### 核心类：LLMAdventureGame

- `__init__()`：初始化游戏状态和UI界面，设置窗口大小和最小尺寸
- `setup_ui()`：创建和布局所有UI组件，采用grid布局实现自适应
- `start_game()`：游戏入口，验证输入并开始故事生成
- `submit_choice()`：处理玩家的选择输入
- `make_choice()`：根据玩家选择推进故事
- `generate_next_segment()`：准备prompt并调用AI
- `_call_llm_in_thread()`：后台线程调用API
- `check_llm_queue()`：检查AI响应队列
- `process_llm_response()`：解析AI返回的文本数据
- `update_story_display()`：更新故事显示区域
- `update_options_display()`：更新选项显示区域
- `toggle_controls()`：切换控件状态
- `show_debug_info()`：显示AI原始响应，用于调试

### 异步处理机制

游戏使用队列（Queue）和线程（Threading）实现异步处理：

1. 主UI线程负责界面交互
2. 工作线程负责API调用
3. 队列用于线程间通信
4. 定时检查队列获取AI响应

### AI交互格式

最终版游戏能够处理AI返回的纯文本格式，自动提取故事和选项。AI返回格式示例：

```
随着晨星号缓缓降落在X-17星球表面，你透过驾驶舱的窗户向外望去，只见一片奇异而迷人的景象...

### 行动选项

**探索周围环境**-你决定先检查一下飞船降落点附近的区域...

**启动紧急信号发射器**-考虑到情况危急，你认为最明智的选择是立即激活晨星号上的紧急求救信号...

**尝试自行修理飞船**-凭借着多年积累下来的机械知识，你觉得或许自己就能够解决当前遇到的问题...

**与本地生物交流**-在降落过程中，你注意到不远处有一群外形奇特的生物正在好奇地观察着你们...
```

## 技术特点

### 长期记忆机制

游戏会将完整的故事历史发送给AI，确保故事的连贯性：

```
故事背景 + 所有已发生的情节 + 玩家选择 = 完整的上下文
```

### 错误处理

- API调用失败时提供重试选项
- JSON解析错误时显示原始响应
- 网络异常时的友好提示

### 用户体验

- 生成过程中显示加载状态
- 鼠标指针变化提供视觉反馈
- 自动滚动到最新内容
- 响应式布局设计

## 自定义配置

### 修改AI模型

在`_call_llm_in_thread()`方法中可以更改使用的模型：

```python
response = Generation.call(
    model='qwen-max',  # 可改为 'qwen-plus', 'qwen-turbo' 等
    # ...
)
```

### 调整故事风格

修改`generate_next_segment()`中的system_prompt来改变AI的创作风格。

### 自定义UI样式

在`update_story_display()`方法中可以修改CSS样式来改变显示效果。

## 故障排除

### 常见问题

1. **导入错误**：确保已安装所有依赖包
2. **API调用失败**：检查API Key是否正确，网络连接是否正常
3. **界面显示异常**：确保系统支持Tkinter

### 调试模式

可以在代码中添加日志输出来调试问题：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 许可证

本项目采用MIT许可证。

## 贡献

欢迎提交Issue和Pull Request来改进这个项目！

## 更新日志

### v2.0.0 (最终优化版)
- 改进UI布局：采用grid布局，实现自适应窗口大小
- 增加窗口最小尺寸限制，防止窗口过小
- 优化各区域比例：故事区域、选项区域和控制区域
- 增强文本解析能力：支持纯文本格式的AI响应
- 增加更多自定义选项：模型选择、段落长度、故事类型和选项风格
- 改进错误处理机制

### v1.0.0
- 初始版本发布
- 基础GUI界面
- 阿里云百炼API集成
- 异步处理机制
- Markdown渲染支持